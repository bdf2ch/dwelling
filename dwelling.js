"use strict";

var data = {
    "4": {
        "id": "153813",
        "status": "20",
        "type": "living",
        "geo_flatnum": "4",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "1",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "1909900.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "5": {
        "id": "153814",
        "status": "20",
        "type": "living",
        "geo_flatnum": "5",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "1",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "1902800.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView" :null
    },
    "10": {
        "id": "153819",
        "status": "20",
        "type": "living",
        "geo_flatnum": "10",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "2",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "12": {
        "id": "153821",
        "status": "20",
        "type": "living",
        "geo_flatnum": "12",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "2",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "19": {
        "id": "153580",
        "status": "20",
        "type": "living",
        "geo_flatnum": "19",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "3",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "20": {
        "id": "153581",
        "status": "20",
        "type": "living",
        "geo_flatnum": "20",
        "estate_rooms": "3",
        "geo_house_entrance": "1",
        "estate_floor": "3",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "26": {
        "id": "153587",
        "status": "20",
        "type": "living",
        "geo_flatnum": "26",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "4",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "38": {
        "id": "153599",
        "status": "20",
        "type": "living",
        "geo_flatnum": "38",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "6",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "40": {
        "id": "153601",
        "status": "20",
        "type": "living",
        "geo_flatnum": "40",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "6",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "41": {
        "id": "153602",
        "status": "20",
        "type": "living",
        "geo_flatnum": "41",
        "estate_rooms": "3",
        "geo_house_entrance": "1",
        "estate_floor": "6",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "45": {
        "id": "153606",
        "status": "20",
        "type": "living",
        "geo_flatnum": "45",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "7",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "48": {
        "id": "153609",
        "status": "20",
        "type": "living",
        "geo_flatnum": "48",
        "estate_rooms": "3",
        "geo_house_entrance": "1",
        "estate_floor": "7",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "52": {
        "id": "153613",
        "status": "20",
        "type": "living",
        "geo_flatnum": "52",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "8",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "55": {
        "id": "153616",
        "status": "20",
        "type": "living",
        "geo_flatnum": "55",
        "estate_rooms": "3",
        "geo_house_entrance": "1",
        "estate_floor": "8",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "59": {
        "id": "153620",
        "status": "20",
        "type": "living",
        "geo_flatnum": "59",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "9",
        "estate_area": "53.5000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2006250.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "61": {
        "id": "153622",
        "status": "20",
        "type": "living",
        "geo_flatnum": "61",
        "estate_rooms": "2",
        "geo_house_entrance": "1",
        "estate_floor": "9",
        "estate_area": "53.4000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2002500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "69": {
        "id": "153630",
        "status": "20",
        "type": "living",
        "geo_flatnum": "69",
        "estate_rooms": "3",
        "geo_house_entrance": "2",
        "estate_floor": "2",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "70": {
        "id": "153631",
        "status": "20",
        "type": "living",
        "geo_flatnum": "70",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "2",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "77": {
        "id": "153638",
        "status": "20",
        "type": "living",
        "geo_flatnum": "77",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "3",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "79": {
        "id": "153640",
        "status": "20",
        "type": "living",
        "geo_flatnum": "79",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "3",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "84": {
        "id": "153645",
        "status": "20",
        "type": "living",
        "geo_flatnum": "84",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "4",
        "estate_area": "53.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2010000.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "90": {
        "id": "153651",
        "status": "20",
        "type": "living",
        "geo_flatnum": "90",
        "estate_rooms": "3",
        "geo_house_entrance": "2",
        "estate_floor": "5",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "104": {
        "id": "153665",
        "status": "20",
        "type": "living",
        "geo_flatnum": "104",
        "estate_rooms": "3",
        "geo_house_entrance": "2",
        "estate_floor": "7",
        "estate_area": "82.6000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2932300.0000",
        "estate_price_m2": "35500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "114": {
        "id": "153675",
        "status": "20",
        "type": "living",
        "geo_flatnum": "114",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "8",
        "estate_area": "53.8000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2017500.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    },
    "121": {
        "id": "153682",
        "status": "20",
        "type": "living",
        "geo_flatnum": "121",
        "estate_rooms": "2",
        "geo_house_entrance": "2",
        "estate_floor": "9",
        "estate_area": "53.5000",
        "estate_area_living": null,
        "estate_area_kitchen": null,
        "estate_area_loggia": null,
        "estate_price": "2006250.0000",
        "estate_price_m2": "37500.0000",
        "estate_living_new": "1",
        "estate_category_type": "12285",
        "estate_windowView": null
    }
};










function House () {
    this.number = 0;
    this.img = "";
};



function Flat () {
    this.id = 0;
    this.status = 0;
    this.type = "";
    this.flatNumber = 0;
    this.roomsCount = 0;
    this.entrance = 0;
    this.floor = 0;
    this.area = {
        total: 0,
        living: 0,
        kitchen: 0,
        loggia: 0
    };
    this.price = 0;
    this.pricePerMeter = 0;
    this.livingNew = 0;
    this.categoryType = 0;
    this.windowView = 0;
};





var dwellingModule = angular.module("dwelling", [])
    .config(function ($provide) {
        $provide.service("$dwelling", ["$log", "$http", "$window", function ($log, $http, $window) {
            var service = {};

            var container = document.getElementById("dwelling");
            var svgContainer = document.getElementById("dwelling-svg");
            var complex = undefined;
            var queues = [];
            var markers = [];



            /**
             * Класс, описывающий маркер на карте
             * @param parameters {Object} - параметры инициализации объекта
             * @constructor
             */
            function Marker (parameters) {
                this.id = "";
                this.x = 0;
                this.y = 0;
                this.caption = "";
                this.title = "";
                this.class = "";
                var visible = true;
                this.xPosition = "0px";
                this.yPosition = "0px";
                this.queueId = "";


                if (parameters !== undefined) {
                    for (var param in parameters) {
                        if (this.hasOwnProperty(param))
                            this[param] = parameters[param];
                    }
                    var width = container.clientWidth;
                    var height = container.clientHeight;
                    this.xPosition = ((width / 100) * this.x) + "px";
                    this.yPosition = ((height / 100) * this.y) + "px";
                }

                this.isVisible = function () {
                    return visible;
                };

                this.show = function () {
                    visible = true;
                };

                this.hide = function () {
                    visible = false;
                };

                this.getX = function () {
                    return this.xPosition;
                };

                this.getY = function () {
                    return this.yPosition;
                };
            };


            service.markers = {
                items: [],
                get: function () {
                    return service.markers.items;
                },
                add: function (parameters) {
                    if (parameters !== undefined) {
                        var marker = new Marker(parameters);
                        service.markers.items.push(marker);
                        return marker;
                    }
                },
                hide: function (markerId) {
                    var markersLength = markers.length;
                    for (var i = 0; i < markersLength; i++) {
                        if (markerId !== undefined && markers[i].id === markerId)
                            markers[i].hide();
                        else
                            markers[i].hide();
                    }
                }
            };



            /**
             * Класс, описывающий жилой комплекс
             * @param parameters {Object} - параметры инициализации объекта
             * @constructor
             */
            function Complex (parameters) {
                this.img = "";
                var queues = [];

                if (parameters !== undefined) {
                    for (var param in parameters) {
                        if (this.hasOwnProperty(param))
                            this[param] = parameters[param];
                    }
                    if (this.img !== undefined && this.img !== "") {
                        //svgContainer.style.backgroundImage = "url('" + this.img + "')";
                    }
                }

                this.queues = {
                    get: function () {
                        return queues;
                    },
                    add: function (parameters) {
                        if (parameters !== undefined) {
                            var queue = new Queue(parameters);
                            queues.push(queue);
                            return queue;
                        }
                    }
                };
            };



            /**
             * Класс, описывающий очередь строительства
             * @param parameters {Object} - параметры инициализации объекта
             * @constructor
             */
            function Queue (parameters) {
                this.number = 0;
                this.img = "";
                this.geometry = [];

                var element = undefined;
                var selected = false;

                if (parameters !== undefined) {
                    for (var param in parameters) {
                        if (this.hasOwnProperty(param))
                            this[param] = parameters[param];
                    }
                }

                this.select = function (flag) {
                    if (flag !== undefined && glag.constructor === Boolean) {
                        selected = flag;
                        return selected;
                    }
                };

                this.draw = function () {
                    var width = container.clientWidth;
                    var height = container.clientHeight;
                    var scrollHeight = container.scrollHeight;
                    var scrollWidth = container.scrollWidth;
                    var scrollTop = container.scrollTop;
                    var scrollLeft = container.scrollLeft;
                    //$log.log("clientWidth = ", svgWidth, ", clientHeight = ", svgHeight);
                    //$log.log("scrollHeight = ", scrollHeight);
                    //$log.log("scrollTop = ", scrollTop);
                    $log.log("container = ", angular.element(container));
                    if (this.geometry.constructor === Array && this.geometry.length > 0) {
                        var points = "";
                        var length = this.geometry.length;
                        for (var i = 0; i < length; i++) {
                            //var proportionX = 1920 / svgWidth;
                            //var proportionY = 1080 / svgHeight;
                            //var offsetX = (1920 - svgWidth) / proportionX;
                            //var proportion = svgWidth / svgHeight;
                            //$log.log("proportionX = ", proportionX);
                            //$log.log("proportionY = ", proportionY);

                            var x = (((width / 100) * this.geometry[i][0]));
                            var y = (((height / 100) * this.geometry[i][1]));
                            //var y = ((scrollHeight / 100)  * this.geometry[i][1]);
                            $log.log("x = ", x, ", y = ", y);
                            var points = points +  x + "," + y;
                            points = (i < length - 1) ? points + "," : points;
                        }
                        if (element !== undefined) {
                            element.setAttribute('points', points);
                        } else {
                            var polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                            polyline.id = "queue-" + this.number;
                            polyline.setAttribute('points', points);
                            svgContainer.appendChild(polyline);
                            element = polyline;
                        }
                        return this;
                    }
                };

            };




            angular.element($window).on("resize", function () {
                $log.log("resized");
                var length = complex.queues.get().length;
                $log.log("length = ", length);
                for (var i = 0; i < length; i ++) {
                    complex.queues.get()[i].draw();
                }

                /*
                var markers_length = service.markers.items.length;
                for (var x = 0; x < markers_length; x++) {
                    $log.log("xpos = ", service.markers.items[x].xPosition, ", ypos = ", service.markers.items[x].yPosition);
                    service.markers.items[x].redraw();
                    $log.log(service.markers.items[x]);
                }
                */
            });



            service.complex = {
                set: function (parameters) {
                    if (parameters !== undefined) {
                        complex = new Complex(parameters);
                    }
                },

                get: function () {
                    return complex;
                }
            };


            service.getQueue = function () {
                $http.post("")
                    .success(function (data) {
                        if (data !== undefined) {

                        }
                    });
            };


            service.getHouses = function () {
                $http.post("")
                    .success(function (data) {
                        if (data !== undefined) {

                        }
                    });
            };


            service.getFlats = function (houseId) {
                $http.post("")
                    .success(function (data) {
                        if (data !== undefined) {

                        }
                    });
            };


            return service;
        }])
    })
    .run(function ($log, $dwelling) {
        $dwelling.complex.set({
            img: "img/complex.jpg"
        });
        //$dwelling.complex.get().queues.add({
        //    geometry: [[328, 197], [195, 260], [196, 273], [303, 307], [426, 227], [426, 218]]
        //}).draw().drawNumberMarker();

        $dwelling.complex.get().queues.add({
            geometry: [[32.9, 34.9], [19.6, 46.4], [19.7, 48.6], [30.4, 54.6], [42.8, 40.2], [42.8, 38.5]]
        }).draw();

        $dwelling.markers.add({
            id: "testmarker",
            x: 28,
            y: 32,
            class: "queue",
            caption: "1",
            title: "очередь"
        });

        $dwelling.markers.add({
            id: "testmarker2",
            x: 29,
            y: 31,
            class: "flats",
            caption: "28",
            title: "квартир",
            queueId: "testmarker"
        }).hide();

        //$dwelling.markers.hide("testmarker2");

        $log.log("complex = ", $dwelling.complex.get());
    });


var dwellingApp = angular.module("dwellingApp", ["dwelling"]);




dwellingModule.controller("DwellingController", ["$log", "$scope", "$dwelling", "$window", function ($log, $scope, $dwelling, $window) {
    $scope.dwelling = $dwelling;
    $scope.currentQueue = undefined;

    $scope.redrawMarkers = function () {
        var container = document.getElementById("dwelling");
        var width = container.clientWidth;
        var height = container.clientHeight;
        var markersLength = $dwelling.markers.items.length;
        for (var i = 0; i < markersLength; i++) {
            $dwelling.markers.items[i].xPosition = (width / 100) * $dwelling.markers.items[i].x + "px";
            $dwelling.markers.items[i].yPosition = (height / 100) * $dwelling.markers.items[i].y + "px";
        }

    };

    $scope.selectMarker = function (markerId) {
        if (markerId !== undefined) {
            var markersLength = $dwelling.markers.get().length;
            for (var i = 0; i < markersLength; i++) {
                if ($dwelling.markers.get()[i].id === markerId) {
                    if ($dwelling.markers.get()[i].class === "queue") {
                        $scope.currentQueue = $dwelling.markers.get()[i];
                        $log.log("current queue = ", $scope.currentQueue);
                        /*
                        for (var x = 0; x < markersLength; x++) {
                            if ($dwelling.markers.get()[x].queueId !== undefined && $dwelling.markers.get()[x].queueId !== "" && $dwelling.markers.get()[x].queueId === markerId) {
                                $dwelling.markers.get()[x].show();
                            }
                        }
                        */
                    }
                }
            }
        }
    };

    $scope.markerMouseIn = function (markerId) {
        if (markerId !== undefined) {
            var markersLength = $dwelling.markers.get().length;
            for (var i = 0; i < markersLength; i++) {
                if ($dwelling.markers.get()[i].id === markerId) {
                    if ($dwelling.markers.get()[i].class === "queue") {
                        $scope.currentQueue = $dwelling.markers.get()[i];
                        $log.log("current queue = ", $scope.currentQueue);
                        for (var x = 0; x < markersLength; x++) {
                            if ($dwelling.markers.get()[x].queueId !== undefined && $dwelling.markers.get()[x].queueId !== "" && $dwelling.markers.get()[x].queueId === markerId) {
                                $dwelling.markers.get()[x].show();
                            }
                        }
                    }
                }
            }
        }
    };


    $scope.markerMouseOut = function (markerId) {
        if (markerId !== undefined) {
            var markersLength = $dwelling.markers.get().length;
            for (var i = 0; i < markersLength; i++) {
                if ($dwelling.markers.get()[i].id === markerId) {
                    if ($dwelling.markers.get()[i].class === "queue") {
                        $scope.currentQueue = $dwelling.markers.get()[i];
                        $log.log("current queue = ", $scope.currentQueue);
                        for (var x = 0; x < markersLength; x++) {
                            if ($dwelling.markers.get()[x].queueId !== undefined && $dwelling.markers.get()[x].queueId !== "" && $dwelling.markers.get()[x].queueId === markerId) {
                                $dwelling.markers.get()[x].hide();
                            }
                        }
                    }
                }
            }
        }
    };

    angular.element($window).on("resize", function () {
        $log.log("scope resize");
        $scope.redrawMarkers();
        $scope.$apply();
    });
}]);
